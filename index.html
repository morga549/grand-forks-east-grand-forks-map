<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find Your Zone</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --panel-width: 380px;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --bg: #ffffff;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
    }

    #wrap {
      display: grid;
      grid-template-columns: var(--panel-width) 1fr;
      height: 100vh;
    }

    #panel {
      padding: 14px 14px 10px;
      border-right: 1px solid var(--border);
      background: var(--bg);
      overflow: auto;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 10px;
    }

    h2 {
      font-size: 14px;
      margin: 16px 0 8px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    input {
      flex: 1;
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #f9fafb;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #f3f4f6;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .title {
      font-size: 16px;
      margin: 0 0 8px;
    }

    .kv {
      margin: 6px 0;
      font-size: 14px;
    }

    .kv b {
      font-weight: 600;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .status {
      font-size: 13px;
      color: var(--muted);
      margin-top: 10px;
      white-space: pre-wrap;
    }

    /* Tooltip styling for hover labels */
    .zone-tooltip {
      background: rgba(17, 24, 39, 0.9);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .leaflet-tooltip-top:before,
    .leaflet-tooltip-bottom:before,
    .leaflet-tooltip-left:before,
    .leaflet-tooltip-right:before {
      border: none !important;
    }

    .zone-label {
      font-size: 12px;
      font-weight: 600;
      color: rgba(17, 24, 39, 0.90);
      text-shadow: 0 1px 2px rgba(255,255,255,0.9);
      pointer-events: none;  /* don't block clicks on polygons */
      white-space: nowrap;
    }


    @media (max-width: 900px) {
      #wrap {
        grid-template-columns: 1fr;
        grid-template-rows: 300px 1fr;
      }
      #panel {
        border-right: 0;
        border-bottom: 1px solid var(--border);
      }
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="panel">
      <h1>Find Your Zone</h1>

      <div class="row">
        <input
          id="addr"
          placeholder="Enter your address (e.g., 123 4th St, Grand Forks, ND)"
          autocomplete="street-address"
        />
        <button id="go">Search</button>
      </div>

      <div class="hint">
        Tip: include city/state. If you’re in East Grand Forks, add “MN”.
      </div>

      <h2 id="sectionTitle">Zone</h2>

      <div id="info" class="card">
        <div class="small">
          Hover or click a region on the map, or search an address.
        </div>
      </div>

      <div id="status" class="status"></div>

      <hr style="border:0;border-top:1px solid var(--border); margin: 12px 0;" />

      <div class="small">
        Map data © OpenStreetMap contributors.
      </div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    // ===== Config =====
    const GEOJSON_URL = "./regions.geojson";

    // Center between Grand Forks + East Grand Forks
    const DEFAULT_VIEW = { lat: 47.93, lon: -97.03, zoom: 12 };

    // ===== State =====
    let geoLayer = null;
    let regionsGeoJSON = null;
    let selectedLayer = null;
    let addressMarker = null;

    // ===== Map init =====
    const map = L.map("map").setView(
      [DEFAULT_VIEW.lat, DEFAULT_VIEW.lon],
      DEFAULT_VIEW.zoom
    );

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // ===== UI elements =====
    const infoEl = document.getElementById("info");
    const statusEl = document.getElementById("status");
    const sectionTitleEl = document.getElementById("sectionTitle");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function setSectionTitle(text) {
      sectionTitleEl.textContent = text || "Zone";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderInfo(props, extra) {
      const name  = props?.name ?? props?.areaId ?? "Area";
      const phone = props?.phone;
      const email = props?.email;
      const hours = props?.hours;
      const link  = props?.link;
      const notes = props?.notes;
      const state = props?.state;

      infoEl.innerHTML = `
        <div class="title">${escapeHtml(name)}</div>
        ${phone ? `<div class="kv"><b>Phone:</b> ${escapeHtml(phone)}</div>` : ""}
        ${email ? `<div class="kv"><b>Email:</b> <a href="mailto:${encodeURIComponent(email)}">${escapeHtml(email)}</a></div>` : ""}
        ${hours ? `<div class="kv"><b>Hours:</b> ${escapeHtml(hours)}</div>` : ""}
        ${link  ? `<div class="kv"><a href="${escapeHtml(link)}" target="_blank" rel="noopener">More info</a></div>` : ""}
        ${notes ? `<div class="kv">${escapeHtml(notes)}</div>` : ""}
        ${extra ? `<div class="small" style="margin-top:10px;">${escapeHtml(extra)}</div>` : ""}
      `;
    }

    // ===== Labels & styling (color comes from GeoJSON properties.color) =====
    function getFeatureLabel(feature) {
      return feature?.properties?.name || feature?.properties?.areaId || "Area";
    }

    function getFeatureColor(feature) {
      // Expect hex like #2563EB, but any valid CSS color string works.
      return feature?.properties?.color || "#6b7280"; // fallback gray
    }

    const STATE_TO_FILL = {
      MN: "#2563EB", // blue
      ND: "#16A34A"  // green
    };

    const ZONE_BORDER = "#111827";

    function getZoneFill(feature) {
      const t = feature?.properties?.state;
      return STATE_TO_FILL[t] || STATE_TO_FILL.A; // default A
    }

    function baseStyle(feature) {
      const fill = getZoneFill(feature);
      return {
        color: ZONE_BORDER,
        fillColor: fill,
        weight: 2,
        opacity: 0.9,
        fillOpacity: 0.25
      };
    }

    function hoverStyle(feature) {
      const fill = getZoneFill(feature);
      return {
        color: ZONE_BORDER,
        fillColor: fill,
        weight: 3,
        opacity: 1,
        fillOpacity: 0.35
      };
    }

    function selectedStyle(feature) {
      const fill = getZoneFill(feature);
      return {
        color: "#000000",
        fillColor: fill,
        weight: 4,
        opacity: 1,
        fillOpacity: 0.50
      };
    }

    function clearSelection() {
      if (selectedLayer) {
        selectedLayer.setStyle(baseStyle(selectedLayer.feature));
      }
      selectedLayer = null;
      setSectionTitle("Zone");
    }

    function setSelected(layer) {
      if (selectedLayer && selectedLayer !== layer) {
        selectedLayer.setStyle(baseStyle(selectedLayer.feature));
      }

      selectedLayer = layer;
      selectedLayer.setStyle(selectedStyle(layer.feature));
      selectedLayer.bringToFront();

      const props = layer.feature?.properties || {};
      setSectionTitle(props.name || props.areaId || "Zone");
      renderInfo(props);
    }

    function onEachFeature(feature, layer) {
      layer.setStyle(baseStyle(feature));

      layer.bindTooltip(getFeatureLabel(feature), {
        sticky: true,
        direction: "auto",
        opacity: 0.9,
        className: "zone-tooltip"
      });

      layer.on("mouseover", () => {
        if (layer !== selectedLayer) layer.setStyle(hoverStyle(feature));
        layer.openTooltip();
      });

      layer.on("mouseout", () => {
        if (layer !== selectedLayer) layer.setStyle(baseStyle(feature));
        layer.closeTooltip();
      });

      layer.on("click", () => setSelected(layer));
    }



    // ===== Geocoding =====
    async function geocodeAddress(q) {
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");
      url.searchParams.set("q", q);

      const resp = await fetch(url.toString(), { headers: { "Accept": "application/json" } });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Geocoding failed (HTTP ${resp.status}). ${text.slice(0,200)}`);
      }

      const data = await resp.json();
      if (!data?.length) return null;

      return {
        lat: Number(data[0].lat),
        lon: Number(data[0].lon),
        display: data[0].display_name
      };
    }

    // ===== Spatial match =====
    function findContainingFeature(lon, lat, geojson) {
      const pt = turf.point([lon, lat]);
      for (const f of geojson.features || []) {
        if (turf.booleanPointInPolygon(pt, f)) return f;
      }
      return null;
    }

    function placeAddressMarker(lat, lon) {
      if (addressMarker) map.removeLayer(addressMarker);
      addressMarker = L.circleMarker([lat, lon], {
        radius: 7,
        weight: 2,
        fillOpacity: 0.7
      }).addTo(map);
    }

    function matchFeatureToLeafletLayer(matchFeature) {
      const matchId = matchFeature?.properties?.areaId;
      if (!matchId) return null;

      let found = null;
      geoLayer.eachLayer(layer => {
        const p = layer.feature?.properties || {};
        if (p.areaId === matchId) found = layer;
      });
      return found;
    }

    // ===== Load regions =====
    async function loadRegions() {
      setStatus("Loading regions…");

      const resp = await fetch(GEOJSON_URL);
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Failed to load ${GEOJSON_URL} (HTTP ${resp.status}). First 200 chars:\n${text.slice(0,200)}`);
      }

      regionsGeoJSON = await resp.json();

      // Basic sanity checks to avoid silent failure
      if (!regionsGeoJSON || regionsGeoJSON.type !== "FeatureCollection") {
        throw new Error(`regions.geojson must be a GeoJSON FeatureCollection. Got: ${regionsGeoJSON?.type}`);
      }

      geoLayer = L.geoJSON(regionsGeoJSON, { onEachFeature }).addTo(map);

      // Fit to regions if possible
      try {
        map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
      } catch (_) {}

      setStatus("");
    }

    // ===== Address search =====
    async function runSearch() {
      const q = document.getElementById("addr").value.trim();
      if (!q) return;

      setStatus("Searching address…");
      infoEl.innerHTML = `<div class="small">Searching…</div>`;

      try {
        const hit = await geocodeAddress(q);
        if (!hit) {
          setStatus("");
          infoEl.innerHTML = `<div class="small">No matching address found.</div>`;
          return;
        }

        placeAddressMarker(hit.lat, hit.lon);

        const match = findContainingFeature(hit.lon, hit.lat, regionsGeoJSON);
        if (!match) {
          clearSelection();
          setSectionTitle("Outside service area");
          renderInfo({ name: "Outside service area" }, hit.display);
          map.setView([hit.lat, hit.lon], 14);
          setStatus("");
          return;
        }

        // Prefer selecting the actual Leaflet layer for proper styling + bounds
        const leafletLayer = matchFeatureToLeafletLayer(match);
        if (leafletLayer) {
          setSelected(leafletLayer);
          map.fitBounds(leafletLayer.getBounds(), { padding: [20, 20] });
        } else {
          // Fallback: show info even if we can't map to a layer (e.g., missing areaId)
          setSectionTitle(match.properties?.name || match.properties?.areaId || "Zone");
          renderInfo(match.properties || {}, hit.display);
          map.setView([hit.lat, hit.lon], 14);
        }

        setStatus("");
      } catch (e) {
        console.error(e);
        setStatus("");
        infoEl.innerHTML = `<div class="small">Address lookup failed.</div>`;
      }
    }

    document.getElementById("go").addEventListener("click", runSearch);
    document.getElementById("addr").addEventListener("keydown", e => {
      if (e.key === "Enter") runSearch();
    });

    // ===== Boot =====
    loadRegions().catch(err => {
      console.error(err);
      setStatus("ERROR:\n" + err.message);
      alert(err.message);
    });
  </script>
</body>
</html>
